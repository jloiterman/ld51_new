pico-8 cartridge // http://www.pico-8.com
version 38
__lua__
#include math2d.p8
#include physics.p8
#include broadphase.p8
#include geometry.p8
#include charcontrol.p8

local frame, anim, collide, vp, s, cc, box1, box2 = 0, 0, true

function _init()
    vp = viewport()
    s  = scene()
    cc = charcontroller(s,{x=-0.5})

    s.add_body{ x=0, y=-4, mass=0, moi=0, rest=0, verts=rectangle(9, 1) }


    box1=s.add_body{x=-3,y=-3.5, mass=1}
    box2=s.add_body{x=-1,y=-3.5, verts=capsule(1, 0.4, 8)}
    rock1=s.add_body{x=1,y=-3.5}
    rock2=s.add_body{x=3,y=-3.5}

end


function _update60()
    cc.update()
    s.update()

    if btn(2) then  s.apply_impulse(box2,0,0.5,0)  end
    if btn(3) then s.apply_impulse(box2,0,0.9,0) end
    
end

function _draw()
    cls()

    local wx, wy = s.position(cc.id())
    local psx, psy = vp.to_screen(wx, wy)
    camera(psx-64,psy-64)

    local x, y, a, px, py
    x, y, a = s.position(box1)
    px, py = vp.to_screen(x, y)
    rspr(80, 16, px-7, py-7, a, 2)

    x, y, a = s.position(box2)
    px, py = vp.to_screen(x, y)
    rspr(96, 16, px-7, py-7, a, 2)

    
    local state = cc.state()
    
    
    map(0, 0, 0, 0, 16, 16)
    
    if (collide) s.draw(vp)
    camera()
    print(anim)
end

function rspr(sx,sy,x,y,a,w)
    local ca,sa=cos_sin(a)
    local srcx,srcy,addr,pixel_pair
    local ddx0,ddy0=ca,sa
    local mask=shl(0xfff8,(w-1))
    w*=4
    ca*=w-0.5
    sa*=w-0.5
    local dx0,dy0=sa-ca+w,-ca-sa+w
    w=2*w-1
    for ix=0,w do
        srcx,srcy=dx0,dy0
        for iy=0,w do
            if band(bor(srcx,srcy),mask)==0 then
                local c=sget(sx+srcx,sy+srcy)
                if (c>0) pset(x+ix,y+iy,c)
            end
            srcx-=ddy0
            srcy+=ddx0
        end
        dx0+=ddx0
        dy0+=ddy0
    end
end


__gfx__
0000000000000000000000000000000000000000006fff000000000000000000006fff0000000000000000000000000033333333000000000000000000000000
000000000000000006fff000006fff0006fff0000066ff00006fff00006fff000066ff00006fff00006fff000000000034334334000000000000000000000000
0000000000000000066ff0000066ff00066ff000000fff000066ff000066ff00000fff000066ff000066ff000000000043434343000000000000000000000000
000000000000000000fff000000fff0000fff00000f778f000ffff0000ffff00000778f000ffff0000ffff000000000043434444000000000000000000000000
0000000000000000007780000007780000778000000778000007780000077800000f7800000778f0000778f00000000044444444000000000000000000000000
000000000000000000f78000000f7800007f800000111100000f78000007f80000111100000f7800000f78000000000044444444000000000000000000000000
00000000000000000011100000011100011140000400004000411100000111400400004000411100004111000000000044444444000000000000000000000000
00000000000000000004400000004400040000000000000000000400004000000000000000000400000004000000000044444444000000000000000000000000
00000000000000000000000000000000006fff000000000000000000006fff000000000000000000000000000000000000000000000000000000000000000000
0000000000000000006fff0006fff0000066ff00006fff00006fff000066ff00006fff0000000000000000000000000000000000000000000000000000000000
00000000000000000066ff00066ff000000fff000066ff000066ff00000fff000066ff0000000000000000000000000000000000000000000000000000000000
0000000000000000000fff0000fff00000f778f000ffff0000ffff00000778f000ffff0000000000000000000000000000000000000000000000000000000000
00000000000000000007780000778000000778000007780000077800000f7800000778f000000000000000000000000000000000000000000000000000000000
0000000000000000000f7800007f800000111100000f78000007f80000111100000f780000000000000000000000000000000000000000000000000000000000
00000000000000000001110001114000040000400041110000011140040000400041110000000000000000000000000000000000000000000000000000000000
00000000000000000000440004000000000000000000040000040000000000000000040000000000000000000000000000000000000000000000000000000000
000000000fff0fff00303000000550000005500000055000000550000000000000055000000550004995444544454440000000660000000008bbb80008bbb800
00000000ff0ffff003333330000ff000000ff000000ff000000ff000000ff000000ff000000ff000444544454445994000000665550000000b0b0b000b0b0b00
00700700fffff0ff38838383066666600776d0000776d0000776d0000776d0000776d0000776d000994594454445444000066655555000000b0b0b000b0b0b00
00077000ffffffff88888888066666600776d000077660000776d0000766d0000776d00007766f0044454945499544400060655555500d50bb8bbbb80b8bbbb0
00077000f0f0ff0f887087080fddddf0077fd000077df000077fdf0007fdd000077fd000077dd0004495494544454940066055555500dd50bbbb8bbb0bbb8bb0
00700700ffffffff0877877000d00d00000dd000000ddd00000dd000000dd000000ddd00000dd0004495444544454440655505550006d5508b8bbb8008b8bb80
00000000f0ff0fff0088880000d00d00000dd000000d0d0000d0d00000d0d000000d0d00000dd0004445944544454440655500050666d500bbb00bb00bb00bb0
00000000fffffff0000880000010010000011000000101000010100000101000000101000001100044459445494544405555550006ddd5552200022000220220
00000000000000000000000000000000000000000000000000000000000000000000000000000000444549954945944055555506500555550000000000066000
00000000000000000000000000000000000000000000000000000000000000000000000000000000449544459945944055555506550055550000000000076000
0000000000000000000000000000000000000000000000000000000000000000000000000000000049459445444544900055550055505550aa00555000076000
00000000000000000000000000000000000000000000000000000000000000000000000000000000494544454995499000555506555000000aab8880067ccd60
000000000000000000000000000000000000000000000000000000000000000000000000000000004495494544454940000556065555550000b6668067ccccc6
0000000000000000000000000000000000000000000000000000000000000000000000000000000044454445494544400005560655555500088688806cdcdcd6
00000000000000000000000000000000000000000000000000000000000000000000000000000000994544454445499000055006655500000886688006cccd60
00000000000000000000000000000000000000000000000000000000000000000000000000000000494544454445444000000006555000000886888000666600
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000c0c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000000000000000000000000010c0c0c00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000c0c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000c0c0c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000c0c000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0c0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000001000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
